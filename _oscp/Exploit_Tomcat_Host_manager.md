Exploit :: Tomcat Host-manager

# Tomcat exploit variant : host-manager

During an internal audit mission, I was led to exploit a Windows based Tomcat instance. Now usually, exploiting a Tomcat instance involves accessing the “manager”, which is suite a simple exploit.

However, in this context, the manager was not accessible (403 HTTP error). But, and this is where it gets interesting, the host-manager was reachable.

**Context :**
Our target -> Windows 2012R2 server (192.168.56.31)
Command Control C&C (Our Machine) -> Ubuntu 16.04 (192.168.56.1)
Tomcat Version -> Latest release at the time of writing (8.5.37)

## Reconnaissance

A nmap scan on the target host reveals that Tomcat is listening on the 8080 port.

[![1-2012-nmap.png](../_resources/bd064782ab8c8927f5e7803972eea1b8.png)](https://www.certilience.fr/wp-content/uploads/2019/03/1-2012-nmap.png)

This kind of target is ideal when auditing, because as a rule of thumb Tomcat is running with “nt authority\system” rights on the Windows host, which enables us to gain total control on the server should we succeed in breaching it. This in turn grants us passwords and hashes that will then enable us to move forward in our privilege escalation in the network.

[![2-2012-tomcat-page-default-o4gwcf5vm6fraae1or8etxbcv6v47n9lnrptit9aa6.png](../_resources/601aab1ce086a4c7e55905f71e3e001b.png)](https://www.certilience.fr/wp-content/uploads/2019/03/2-2012-tomcat-page-default.png)

## Authentification

On first discovery of a Tomcat instance, the first action as an auditor is to try and authenticate through the manager. We generally try default credentials such as admin/admin or tomcat/tomcat.

In this instance, I got an “Access Refused 403” when trying to access the manager with the “tomcat/tomcat” combo.

[![3-2012-manager-deny-o4gwcg3pt0h1lwcoj9n1ef2tgkqhfcdbzwdb037via.png](../_resources/f5e11f21dcc934c5b28576c2f7e0de74.png)](https://www.certilience.fr/wp-content/uploads/2019/03/3-2012-manager-deny.png)

But, when I try the same thing on the host-manager ….
… boom, HTTP 200, we are in.

[![4-2012-host-manager-first-o4gwcg3pt0h1lwcoj9n1ef2tgkqhfcdbzwdb037wcu.png](../_resources/a50e55dc83d72be39c7048840469af4c.png)](https://www.certilience.fr/wp-content/uploads/2019/03/4-2012-host-manager-first.png)

A few techniques are available to automatize the bruteforce phase:

### Module Metasploit : auxiliary/scanner/http/tomcat_mgr_login

[![6-2012-tomcat_bruteforce-o4gwchze6ojm949y8agajelqnch7uqkso5o9yn54vi.png](../_resources/e4662d7db3e3e888cf427ef85fcd6d5a.png)](https://www.certilience.fr/wp-content/uploads/2019/03/6-2012-tomcat_bruteforce.png)

### Hydra

[![5-2012-hydra-o4gwch1jzuibxibbds1nywua1ylun1h2c10shd6hcw.png](../_resources/78751dad18ef504d258884bb6ebd2c73.png)](https://www.certilience.fr/wp-content/uploads/2019/03/5-2012-hydra.png)

### Nikto (it integrates a test with the login combo “tomcat/tomcat”)

[![7-2012-nikto-o4gwchze6ojm949y8agajelqnch7uqkso5o9yn52vu.png](../_resources/269c4185e78d60853646af6008df0bc3.png)](https://www.certilience.fr/wp-content/uploads/2019/03/7-2012-nikto.png)

### A few scripts linked to Tomcat

e.g. : *https://gist.github.com/th3gundy/d562eb1ae5dc42d666d3aab761bd4d96*

## Exploiting the « host-manager »

Ok, so we’ve got access to the host-manager, now what?

The application does not have and upload form, and from what I’d gathered from the documentation, you need to know and control the path of the application you want to deploy, as well as a valid vhost.

And when I was reading the doc again, I had the idea which would later become the exploit: what if I could create a UNC path pointing towards an SMB server (smbserver.py by impacket) that I controled !

[![8-2012-host-manager-detection-o4gwcix8dikwkq8l2sux3wd78qcl2foj0abrfx3q32.png](../_resources/dc33cdde19b0dc6f401292df7fce7d1b.png)](https://www.certilience.fr/wp-content/uploads/2019/03/8-2012-host-manager-detection.png)

Bingo! Tomcat connects to my server!

[![9-2012-host-manager-detection-smbserver-o4gwcjv3s7e21r0o05g99d50hlzdo00smq2l1n0jo8.png](../_resources/11e94bf2ca0f621b0b970e9d4b45d3a3.png)](https://www.certilience.fr/wp-content/uploads/2019/03/9-2012-host-manager-detection-smbserver.png)

Which means that Tomcat interprets the UNC path and is trying to install an application from the “datatest” folder. We will oblige it and create the “datatest” folder, and add a little WAR file in which we insert a backdoor that will enable us to take over the server from our C&C.

### 1- Creating a WAR

Creating a WAR is relatively simple; it’s a zip file whose extension we change to .war. Inside the zip file we have a JSP file that lets us execute system commands through the browser.

We create our own ZIP with the backdoor inside it…

[![10-2012-generate-war-o4gwcjv2kcm6wc77xb9joe4nu47ya4s9cez8x72cqu.png](../_resources/5e8a39e77194486cccf5736952e951a5.png)](https://www.certilience.fr/wp-content/uploads/2019/03/10-2012-generate-war.png)

… and change the extension:

[![11-2012-generate-war-zip-o4gwcksxz1fcdczaunuvtuwh2zuqvp4iyuq2iwz5ai.png](../_resources/327645b6cb94fa52d076b6c0fb2c3345.png)](https://www.certilience.fr/wp-content/uploads/2019/03/11-2012-generate-war-zip.png)

For all you script kiddies out there that aren’t sure about what you’re doing, you can use the handy msfvenom tool to create a WAR file and execute “meterpreter” directly:

[![12-2012-war-msfvenom-meterpreter-o4gwcksxz1fcdczaunuvtuwh2zuqvp4iyuq2iwz4bs.png](../_resources/040a74a0beb5a86b015c4ef943102fd3.png)](https://www.certilience.fr/wp-content/uploads/2019/03/12-2012-war-msfvenom-meterpreter.png)

### 2- Deploy and pwn

Now that our WAR file is on the Tomcat server and deploy it from our C&C, we are going to use the smbserver.py provided by the “impacket” package to share the following folder:

The deployment is done remotely, and the files are stored on our C&C. To access our backdoor, Tomcat uses the alias, which means it might be necessary to add the server’s IP in the /etc/hosts with vhost that we used for deployment.

Now we configure the application before deployment:

[![15-2012-host-manager-o4gwcbeiuualzujiaplwjy9ihndncuuob93vlpevho.png](../_resources/da23337abd2d28e3142c989950ab643d.png)](https://www.certilience.fr/wp-content/uploads/2019/03/15-2012-host-manager.png)

Success !

[![16-2012-host-manager-appli-installed-o4gwcccd1obwbgi5580j4g0z3190kjyendrd2zdgzi.png](../_resources/876fae1fd1f3ece0bf6e8d491317aa6f.png)](https://www.certilience.fr/wp-content/uploads/2019/03/16-2012-host-manager-appli-installed.png)

Connection of Tomcat from my SMB server during deployment:

[![17-2012-host-manager-smbserver-o4gwcda8gd51sha82klv9wssbwvt64ao9ti6opab5i.png](../_resources/d9c4643b9c7b06e8cb0fffdbde2b6701.png)](https://www.certilience.fr/wp-content/uploads/2019/03/17-2012-host-manager-smbserver.png)

A quick trip to our browser confirms that our backdoor is now in place, and that we can execute system commands on the Windows server.

[![18-2012-host-manager-nt-system-o4gwcda78id6n2grzqf5oxsfof4ds924zieuk9c3lc.png](../_resources/45b63f08af4d24d6562a4d5a6d657481.png)](https://www.certilience.fr/wp-content/uploads/2019/03/18-2012-host-manager-nt-system.png)

Contents of the directory on my machine once deployment is finished:

[![19-2012-repertoire-appli-deployee-smbserver-o4gwce81fcegyofeu8ts9fjw9szqzy5vbn2c1janvu.png](../_resources/6019d24c6e4af827d4df8ec64b97ddff.png)](https://www.certilience.fr/wp-content/uploads/2019/03/19-2012-repertoire-appli-deployee-smbserver.png)

This method of Tomcat exploit has been tested on the following Tomcat versions when hosted on a windows server: <=7.0.92 et <=8.5.37.